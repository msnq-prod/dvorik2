# Обзор Проекта и План Развития

Этот документ описывает текущую архитектуру, компоненты, схемы данных и взаимодействия приложения, а также намечает план дальнейшего развития.

## 1. Артефакты (Компоненты)

Приложение построено на микросервисной архитектуре и состоит из следующих ключевых компонентов (артефактов), разворачиваемых с помощью Docker.

### 1.1. Бэкенд (Backend)
- **Назначение:** Серверное приложение, которое предоставляет REST API для взаимодействия с базой данных и реализации бизнес-логики.
- **Технологии:**
  - **Язык:** Python
  - **Фреймворк:** FastAPI
  - **ORM:** SQLAlchemy
  - **Валидация данных:** Pydantic
- **Расположение:** `v1/backend/`

### 1.2. Телеграм-бот (Bot)
- **Назначение:** Обеспечивает взаимодействие с пользователями через Telegram. Основные функции: регистрация новых пользователей, выдача купонов, отправка уведомлений.
- **Технологии:**
  - **Язык:** Python
  - **Библиотека:** `python-telegram-bot`
- **Расположение:** `v1/bot/`

### 1.3. Админ-панель (Admin Panel)
- **Назначение:** Веб-интерфейс для администраторов. Позволяет управлять пользователями, кампаниями, купонами, отправлять массовые сообщения и напрямую редактировать данные в базе.
- **Технологии:**
  - **Язык:** TypeScript
  - **Сборщик:** Vite
  - **Веб-сервер (в Docker):** Nginx
- **Расположение:** `v1/admin/`

### 1.4. База данных (Database)
- **Назначение:** Хранение всей информации о пользователях, купонах, кампаниях и их взаимодействиях.
- **Технологии:** MySQL
- **Управление:** Docker Compose

---

## 2. Атрибуты (Схема данных)

База данных спроектирована для хранения информации о пользователях, купонах и рекламных кампаниях.

### `users`
Хранит информацию о зарегистрированных пользователях.
| Поле | Тип | Описание |
|---|---|---|
| `id` | `INT` | PK, Auto-increment |
| `telegram_id` | `BIGINT` | Уникальный ID пользователя в Telegram |
| `first_name` | `VARCHAR(255)` | Имя |
| `last_name` | `VARCHAR(255)` | Фамилия |
| `birth_date` | `DATE` | Дата рождения |
| `gender` | `ENUM('male', 'female')` | Пол |
| `subscribed` | `BOOLEAN` | Статус подписки на канал |
| `status` | `VARCHAR(255)` | Статус пользователя (назначается админом) |
| `created_at` | `TIMESTAMP` | Дата регистрации |

### `coupons`
Хранит информацию о сгенерированных купонах.
| Поле | Тип | Описание |
|---|---|---|
| `id` | `INT` | PK, Auto-increment |
| `code` | `VARCHAR(255)` | Уникальный код купона |
| `discount_type`| `ENUM(...)` | Тип скидки (процент, сумма, комментарий) |
| `discount_value`| `DECIMAL(10, 2)`| Значение скидки |
| `expires_at` | `TIMESTAMP` | Дата окончания действия |
| `user_id` | `INT` | FK на `users.id` (для персональных купонов) |
| `campaign_id` | `INT` | FK на `campaigns.id` |

### `campaigns`
Хранит информацию о рекламных кампаниях.
| Поле | Тип | Описание |
|---|---|---|
| `id` | `INT` | PK, Auto-increment |
| `name` | `VARCHAR(255)` | Название кампании |
| `created_at` | `TIMESTAMP` | Дата создания |

---

## 3. Схемы взаимодействий

### Сценарий 1: Регистрация нового пользователя
1.  **Пользователь** отправляет команду `/start` **Телеграм-боту**.
2.  **Бот** запускает диалог (`ConversationHandler`) и последовательно запрашивает: Имя, Фамилию, Дату рождения, Пол.
3.  **Пользователь** отвечает на каждый вопрос.
4.  **Бот**, получив все данные, формирует JSON-объект.
5.  **Бот** отправляет `POST` запрос на эндпоинт `/api/users/` **Бэкенда**.
6.  **Бэкенд** валидирует данные (включая преобразование формата даты), создает новую запись в таблице `users` в **Базе данных** и возвращает успешный ответ.
7.  **Бот** сообщает **Пользователю** об успешной регистрации.

### Сценарий 2: Редактирование данных в админ-панели
1.  **Администратор** открывает **Админ-панель** и переходит на вкладку "Редактор БД".
2.  **Админ-панель (Frontend)** отправляет `GET` запрос на `/api/database/schema` **Бэкенда**.
3.  **Бэкенд** возвращает список таблиц, который отображается в **Админ-панели**.
4.  **Администратор** выбирает таблицу (например, `users`).
5.  **Админ-панель** отправляет `GET` запрос на `/api/database/users` **Бэкенда**.
6.  **Бэкенд** извлекает все записи из таблицы `users` и возвращает их.
7.  **Админ-панель** отображает данные в виде редактируемой таблицы.
8.  **Администратор** изменяет значение в ячейке и нажимает кнопку "Сохранить" в строке.
9.  **Админ-панель** собирает все данные из измененной строки и отправляет `PUT` запрос на `/api/database/users/{row_id}` **Бэкенда**.
10. **Бэкенд** обновляет соответствующую запись в **Базе данных** и возвращает подтверждение.

---

## 4. План развития

Текущее состояние проекта — это хорошо спроектированный **каркас (скелет)**. Для превращения его в полнофункциональное приложение необходимо выполнить следующие шаги:

### Этап 1: Реализация основной бизнес-логики
- **Бэкенд:**
  - Реализовать логику фильтрации пользователей для массовой рассылки.
  - Реализовать эндпоинт для генерации купонов на основе фильтров (возраст, пол, статус).
  - Добавить эндпоинт для проверки статуса подписки пользователя на Telegram-канал.
  - Внедрить базовую аутентификацию для API (например, по API-ключу).
- **Телеграм-бот:**
  - Реализовать проверку подписки на канал перед выдачей первого купона.
  - Реализовать механизм выдачи и отображения купонов для пользователя.
  - Добавить команду для просмотра "личного кабинета" (свои данные, купоны).
  - Реализовать получение и отображение массовых сообщений от администратора.
- **Админ-панель:**
  - "Оживить" все элементы управления: реализовать отправку сообщений, генерацию купонов с фильтрами.
  - Добавить функционал создания и удаления записей в универсальном редакторе БД.
  - Реализовать отображение статистики по кампаниям.

### Этап 2: Тестирование и стабилизация
- **Unit-тесты:** Написать тесты для критически важной логики бэкенда (генерация купонов, фильтрация).
- **Интеграционные тесты:** Протестировать взаимодействие между ботом, бэкендом и базой данных.
- **E2E-тесты:** Написать Playwright-тесты для админ-панели, чтобы проверять ключевые сценарии.

### Этап 3: Подготовка к развертыванию
- **CI/CD:** Настроить автоматическую сборку, тестирование и развертывание Docker-образов при изменениях в коде.
- **Конфигурация (Production):** Подготовить `.env.prod` и `docker-compose.prod.yml` файлы для боевого окружения.
- **Мониторинг:** Добавить логирование и базовый мониторинг состояния сервисов.
